<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" crossorigin="anonymous">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,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" />
    <title>node-rpi-poweroff</title>
  </head>
  <body>
    <div class="d-grid gap-2 col-10 col-lg-4 mx-auto text-center">
      <div id="res" class="alert text-uppercase mt-3 mb-1" >
        <h4 class="alert-heading m-0" >
      	  <span id="hostname"></span>
    	  <span id="res-status"></span>
         </h4>
       </div>
      <!--<div class="d-grid gap-2 col d-md-block text-nowrap">-->
      <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
	<div class="btn-group pe-1 w-50" role="group" aria-label="First group">
          <a href="/poweroff" onclick="doCmd(event,'poweroff')" id="pwrff" class="btn btn-primary col-md-6" role="button">Poweroff</a>
	</div>
	<div class="btn-group ps-1 w-50" role="group" aria-label="First group">
          <a href="/reboot" onclick="doCmd(event,'reboot')" id="rbt" class="btn btn-secondary col-md-6" role="button">Reboot</a>
	</div>
      </div>
      <!--</div>-->
      <div class="alert alert-secondary" role="alert">
        <div class="container">
	  <div class="row">
	    <div class="col">
	      <span id="shelly-watt">n/a</span>
	    </div>
	    <div class="col">
              <div class="form-switch">
	        <input class="form-check-input" type="checkbox" id="shelly-state" onclick="setShelly()">
              </div>
	    </div>
	  </div>
        </div>
      </div>
      
      <div class="card">
        <div id="stream" class="my-0 py-0">
	  <a href="#" onclick="toggleImg()">
	    <img src="http://192.168.22.19/webcam/?action=snapshot" id="img-snapshot" class="rounded mx-auto d-block img-fluid" />
	    <div class="card-img-overlay">
	      <h5 id="img-desc" class="card-title text-end fw-bold text-light">SS</h5>
	    </div>
	  </a>
        </div>
      </div>
      <div class="container">
	  <div class="row">
	    <div class="col">
	      <div id="pbar" class="progress my-3 mx-sm-5" style="height: 24px;">
	        <div id="op-perc" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
	      </div>
	    </div>
	  </div>
	  <div class="row">
	    <div class="col">State:</div>
	    <div class="col" id="op-state">n/a</div>
	  </div>
	  <div class="row">
	    <div class="col">PTL:</div>
	    <div class="col" id="op-ptl">n/a</div>
	  </div>
	  <div class="row">
	    <div class="col">PT:</div>
	    <div class="col" id="op-pt">n/a</div>
	  </div>
	  <div class="row">
	    <div class="col">Tool:</div>
	    <div class="col">
	      <span id="op-tool"></span>&deg; / <span id="op-toolt"></span>&deg;
	    </div>
	  </div>
	  <div class="row">
	    <div class="col">Bed:</div>
	    <div class="col">
	      <span id="op-bed"></span>&deg; / <span id="op-bedt"></span>&deg;
	    </div>
	  </div>
      </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha256-cMPWkL3FzjuaFSfEYESYmjF25hCIL6mfRSPnW8OVvM4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.10.7/plugin/duration.js"></script>
    <script>
      var urlName = location.protocol + '//' + location.hostname + ':' + window.location.port;
      var actionName = location.pathname.split("/").slice(-1); 
      if (actionName == 'poweroff' || actionName == 'reboot'){
        document.getElementById("res-status").innerHTML = actionName;
        document.getElementById("pwrff").className += " disabled";
	document.getElementById("pwrff").setAttribute('tabindex', -1);
	document.getElementById("pwrff").setAttribute('aria-disabled', true);
	document.getElementById("rbt").className += " disabled";
	document.getElementById("rbt").setAttribute('tabindex', -1);
	document.getElementById("rbt").setAttribute('aria-disabled', true);

	Array.from(document.querySelectorAll('#res.alert-success')).forEach((el) => el.classList.remove('alert-success'));
	Array.from(document.querySelectorAll('#res.alert-danger')).forEach((el) => el.classList.remove('alert-danger'));
        document.getElementById("res").className += " alert-danger";
	setTimeout(function(){
       	  location.href = urlName;
	}, 20000);
      }
    </script>  
    <script>
      // run command reboot or shutdown
      async function doCmd(ev, cmd) {
	//console.log(cmd);
        document.getElementById("res-status").innerHTML = cmd;
	ev.preventDefault();
        let response = await fetch("/" + cmd);
      }
    </script>
    <script>
      // check online state of localhost
      async function checkState() {
        let response = await fetch('/');
        if (response.status === 200) {
            let data = await response.text();
            document.getElementById("res-status").innerHTML = 'online';
	    Array.from(document.querySelectorAll('#res.alert-danger')).forEach((el) => el.classList.remove('alert-danger'));
	    Array.from(document.querySelectorAll('#res.alert-success')).forEach((el) => el.classList.remove('alert-success'));
            document.getElementById("res").className += " alert-success";
	} else {
            document.getElementById("res-status").innerHTML = 'offline';
	    Array.from(document.querySelectorAll('#res.alert-success')).forEach((el) => el.classList.remove('alert-success'));
	    Array.from(document.querySelectorAll('#res.alert-danger')).forEach((el) => el.classList.remove('alert-danger'));
            document.getElementById("res").className += " alert-danger";
	}
      }
      function goCheckState() {
        checkState()
            .then((res) => { 
	      //console.log('online')
              document.getElementById("res-status").innerHTML = 'online';
	      Array.from(document.querySelectorAll('#res.alert-danger')).forEach((el) => el.classList.remove('alert-danger'));
	      Array.from(document.querySelectorAll('#res.alert-success')).forEach((el) => el.classList.remove('alert-success'));
              document.getElementById("res").className += " alert-success";
	    })
	    .catch(function(err) {  
	      //console.log('offline');
              document.getElementById("res").innerHTML = 'offline';
	      Array.from(document.querySelectorAll('#res.alert-success')).forEach((el) => el.classList.remove('alert-success'));
	      Array.from(document.querySelectorAll('#res.alert-danger')).forEach((el) => el.classList.remove('alert-danger'));
              document.getElementById("res").className += " alert-danger";
            });
      }
      goCheckState();
      setInterval(goCheckState, 10000);
    </script>
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>
    <script>
      // shelly
      var client = mqtt.connect('ws://192.168.22.9:1884')
      var subscr = 'shellies/shellyplug-s-A33929'

      function getShelly() {
	// /0,/0/power
	client.subscribe(subscr + '/#')

	client.on('connect', function () {
	  console.log('MQTT: connected ...')
	})

	client.on('disconnect', function () {
	   console.log('MQTT: disconnected ...')
	})

	client.on("message", function (topic, payload) {
	  if (topic === subscr + '/relay/0') {
	    //console.log('Status: ' + payload)
	    if (payload == 'on'){
	      document.getElementById("shelly-state").checked = true;
	    } else {
	      document.getElementById("shelly-state").checked = false;
	   }
	  }
	  if (topic === subscr + '/relay/0/power') {
	    //console.log('Power: ' + payload)
	    if (payload > 0) {
	      document.getElementById("shelly-state").checked = true;
	    }
            document.getElementById("shelly-watt").innerHTML = payload + 'W';
	  }
	  //client.end()
	})
      }
      getShelly();

      // set shelly relay
      function setShelly() {
	// on,off,toggle
	client.publish(subscr + '/relay/0/command', 'toggle')
        /*var checkBox = document.getElementById('shelly-state');
	if (checkBox.checked == true){
	  console.log('Shelly: Turn off')
	  client.publish(subscr + '/relay/0/command', 'off')
  	} else {
	  console.log('Shelly: Turn on')
	  client.publish(subscr + '/relay/0/command', 'on')
	}*/
      }

      // hostname
      async function loadNames() {
	const response = await fetch('/hostname');
        const names = await response.json();
        //console.log(names); 
        document.title = names.hostname;
        document.getElementById("hostname").innerHTML = names.hostname;
        // logs [{ name: 'Joker'}, { name: 'Batman' }]
      }
      loadNames();

      // toggle image
      async function toggleImg() {
	var stream = "http://192.168.22.19/webcam/?action=stream";
	var snapshot = "http://192.168.22.19/webcam/?action=snapshot";
	if ((document.getElementById("img-snapshot").src).includes("snapshot")){
          document.getElementById("img-snapshot").src = stream;
          document.getElementById("img-desc").innerHTML = 'LIVE';
	} else {
          document.getElementById("img-snapshot").src = snapshot;
          document.getElementById("img-desc").innerHTML = 'SS';
	}
      }

      async function loadOctoJob() {
        const response = await fetch('http://192.168.22.19/api/job?apikey=550F9D415E154377BAECB411C2E0B815');
	const job = await response.json();
	//console.log(job); 
	dayjs.extend(window.dayjs_plugin_duration);
	//console.log(dayjs.duration(60, 's').format('HH:mm:ss'));
        document.getElementById("op-state").innerHTML = job.state;
        document.getElementById("op-perc").innerHTML = (job.progress.completion == null ? '0' : Math.round(job.progress.completion*10)/10) + '%';
        document.getElementById("op-perc").style.width = (job.progress.completion == null ? '0' : Math.round(job.progress.completion*10)/10) + '%';
        document.getElementById("op-perc").setAttribute('aria-valuenow',job.progress.completion == null ? '0' : Math.round(job.progress.completion*10)/10);
        document.getElementById("op-pt").innerHTML = dayjs.duration(job.progress.printTime, 's').format('HH:mm:ss');
        document.getElementById("op-ptl").innerHTML = dayjs.duration(job.progress.printTimeLeft, 's').format('HH:mm:ss');
      }
      loadOctoJob();
      setInterval(loadOctoJob, 10000);

      async function loadOctoPrinter() {
        const response = await fetch('http://192.168.22.19/api/printer?apikey=550F9D415E154377BAECB411C2E0B815');
	const printer = await response.json();
	//console.log(printer); 
        document.getElementById("op-bed").innerHTML = printer.temperature.bed.actual;
        document.getElementById("op-tool").innerHTML = printer.temperature.tool0.actual;
        document.getElementById("op-bedt").innerHTML = printer.temperature.bed.target;
        document.getElementById("op-toolt").innerHTML = printer.temperature.tool0.target;
      }
      loadOctoPrinter();
      setInterval(loadOctoPrinter, 10000);
    </script>	  
  </body>
</html>

    </script>	  
  </body>
</html>

